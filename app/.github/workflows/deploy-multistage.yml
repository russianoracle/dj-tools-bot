name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: mood-classifier
  PYTHON_VERSION: "3.12"

jobs:
  # ============================================
  # JOB 1: Security Scan (parallel with build)
  # ============================================
  security:
    name: Security Scan
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: false
          GITLEAKS_ENABLE_SUMMARY: false

  # ============================================
  # JOB 2: Build (uses local cache, skips if valid)
  # ============================================
  build:
    name: Build Image
    runs-on: self-hosted
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to registry
        run: echo '${{ secrets.YC_SA_JSON_KEY }}' | docker login ${{ env.REGISTRY }} --username json_key --password-stdin

      - name: Setup buildx
        run: |
          if ! docker buildx inspect ci-builder >/dev/null 2>&1; then
            docker buildx create --name ci-builder --driver docker-container --bootstrap
          fi
          docker buildx use ci-builder

      - name: Build test image (cached)
        id: build
        run: |
          IMAGE_TAG="mood-classifier:test-${{ github.sha }}"

          # Check if image already exists (from previous run or parallel build)
          if docker image inspect "$IMAGE_TAG" >/dev/null 2>&1; then
            echo "✓ Image already exists, skipping build"
          else
            echo "Building $IMAGE_TAG..."
            docker buildx build \
              --target test \
              --build-arg PYTHON_VERSION=${{ env.PYTHON_VERSION }} \
              --build-arg REGISTRY=${{ env.REGISTRY }} \
              --build-arg REGISTRY_ID=${{ secrets.YC_REGISTRY_ID }} \
              --cache-from type=local,src=/tmp/.buildx-cache \
              --cache-to type=local,dest=/tmp/.buildx-cache,mode=max \
              --load \
              -t "$IMAGE_TAG" \
              -f Dockerfile.unified \
              .
            echo "✓ Build complete"
          fi

          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Logout
        if: always()
        run: docker logout ${{ env.REGISTRY }}

  # ============================================
  # JOB 3: Test (runs on built container)
  # ============================================
  test:
    name: Run Tests
    runs-on: self-hosted
    needs: [security, build]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4

      - name: Start test container
        run: |
          docker rm -f test-app 2>/dev/null || true
          docker run -d \
            --name test-app \
            --network host \
            -e DATA_DIR=/data \
            -e DOWNLOADS_DIR=/tmp/downloads \
            -e REDIS_HOST=localhost \
            -e REDIS_PORT=6379 \
            -v $(pwd)/tests:/app/tests \
            ${{ needs.build.outputs.image_tag }} \
            sleep infinity

          echo "✓ Test container started"

      - name: Run integration tests (first)
        run: |
          docker exec test-app \
            pytest tests/ -m "integration or pipeline" -vv --tb=short

      - name: Run unit tests
        run: |
          docker exec test-app \
            pytest tests/ -m "unit or container" -vv --tb=short

      - name: Cleanup
        if: always()
        run: docker rm -f test-app || true

  # ============================================
  # JOB 4: Push Production Image
  # ============================================
  push:
    name: Push to Registry
    runs-on: self-hosted
    needs: test
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Login to registry
        run: echo '${{ secrets.YC_SA_JSON_KEY }}' | docker login ${{ env.REGISTRY }} --username json_key --password-stdin

      - name: Setup buildx
        run: docker buildx use ci-builder

      - name: Build and push production
        run: |
          docker buildx build \
            --target production \
            --build-arg PYTHON_VERSION=${{ env.PYTHON_VERSION }} \
            --build-arg REGISTRY=${{ env.REGISTRY }} \
            --build-arg REGISTRY_ID=${{ secrets.YC_REGISTRY_ID }} \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --push \
            -t ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest \
            -f Dockerfile.unified \
            .

          echo "✓ Production image pushed"

      - name: Logout
        if: always()
        run: docker logout ${{ env.REGISTRY }}

  # ============================================
  # JOB 5: Deploy to VM
  # ============================================
  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: push
    steps:
      - name: Deploy to production
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@158.160.122.216 << 'EOF'
            echo '${{ secrets.YC_SA_JSON_KEY }}' | docker login ${{ env.REGISTRY }} --username json_key --password-stdin
            docker pull ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
            docker stop mood-classifier 2>/dev/null || true
            docker rm mood-classifier 2>/dev/null || true
            docker run -d \
              --name mood-classifier \
              --restart unless-stopped \
              -v /data:/data \
              -e DATA_DIR=/data \
              ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
            sleep 5
            docker ps | grep mood-classifier
            echo "✓ Deployed"
          EOF

  # ============================================
  # JOB 6: Cleanup
  # ============================================
  cleanup:
    name: Cleanup
    runs-on: self-hosted
    needs: push
    if: always()
    steps:
      - name: Clean old images
        run: |
          docker images --format "{{.Repository}}:{{.Tag}}" | \
            grep "mood-classifier:test-" | \
            tail -n +3 | \
            xargs -r docker rmi -f || true
          docker image prune -f
          echo "✓ Cleanup done"
