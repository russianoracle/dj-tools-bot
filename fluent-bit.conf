[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     error
    Parsers_File  parsers.conf
    storage.path  /var/log/flb-storage/
    storage.sync  normal
    storage.max_chunks_up  128

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Exclude_Path      *fluent-bit*
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    DB                /var/log/flb_docker.db

[FILTER]
    Name                parser
    Match               docker.*
    Key_Name            log
    Parser              json
    Reserve_Data        On
    Preserve_Key        Off

# Rename 'message' to 'log' for parsed JSON logs (replaces original log field)
[FILTER]
    Name                modify
    Match               docker.*
    Rename              message log

[FILTER]
    Name                modify
    Match               docker.*
    Add                 environment production

# Rename parsed JSON fields to YC Logging meta fields
[FILTER]
    Name                modify
    Match               docker.*
    Rename              logger app_logger

[FILTER]
    Name                modify
    Match               docker.*
    Rename              component app_component

[FILTER]
    Name                modify
    Match               docker.*
    Rename              timestamp app_timestamp

[FILTER]
    Name                modify
    Match               docker.*
    Rename              level log_level

# Exclude test-related logs
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /(pytest|test summary|PASSED|FAILED|SKIPPED|test_.*\.py|===|cachedir|rootdir|configfile|plugins:|warnings summary|collecting|collected.*items|asyncio:.*mode=)/

# Exclude buildkit and docker noise
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /(sha256:|pulling|digest:|exporting to image|oci-mediatype|buildkit)/

# Exclude fluent-bit own logs (format: [YYYY/MM/DD HH:MM:SS])
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /^\[20[0-9]{2}\/[0-9]{2}\/[0-9]{2}/

# Exclude docker internal messages
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /(time=.*level=(warning|info).*msg=|forcibly turning on)/

# Exclude empty/whitespace-only logs (including newlines only)
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /^[ \t\n\r]*$/

# Exclude Python code fragments (indented code like "    await ...")
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /^[ \t]+(await|async|def|class|import|from|return|if|else|for|while|try|except|with)\s/

# Exclude standalone closing braces/parentheses
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /^[ \t]*[\)\]\}][ \t]*$/

# Exclude Redis logs (format: "1:M DD MMM YYYY HH:MM:SS.sss * message")
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /^[0-9]+:[MCS] [0-9]{1,2} [A-Z][a-z]{2} [0-9]{4}/

# Exclude Redis warnings and config messages
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /(WARNING Memory overcommit|no config file specified|oO0OoO0OoO0Oo Redis|Running mode=standalone|Server initialized|Ready to accept connections|Background saving|DB saved on disk|Fork CoW for RDB|monotonic clock)/

# Exclude fluent-bit own logs
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /^(yc-logging|fluent)/

# Deduplicate: Exclude stderr logs that start with timestamp (ARQ worker duplicates)
# These are duplicates of stdout logs that ARQ worker emits to both streams
[FILTER]
    Name                grep
    Match               docker.*
    Condition           Key_value_equals stream stderr
    Exclude             log /^[0-9]{2}:[0-9]{2}:[0-9]{2}:/

[OUTPUT]
    Name  yc-logging
    Match docker.*
    resource_type generic_node
    group_id ${YC_LOG_GROUP_ID}
    message_key log
    level_key log_level
    default_level INFO
    authorization instance-service-account

