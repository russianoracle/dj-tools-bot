[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     error
    Parsers_File  parsers.conf
    storage.path  /var/log/flb-storage/
    storage.sync  normal
    storage.max_chunks_up  128

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Exclude_Path      *fluent-bit*
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On

# Exclude fluent-bit's own logs FIRST (format: [YYYY/MM/DD HH:MM:SS])
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /^\[20[0-9]{2}\/[0-9]{2}\/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}\]/

[FILTER]
    Name                modify
    Match               docker.*
    Add                 environment production

# Exclude ALL test-related logs (pytest, test files, test summaries)
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /(pytest|test summary|PASSED|FAILED|SKIPPED|test_.*\.py|===|cachedir|rootdir|configfile|plugins:|warnings summary|Docs: https:\/\/docs\.pytest)/

# Exclude buildkit and docker noise
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /(sha256:|pulling|digest:|exporting to image|oci-mediatype|buildkit)/

# Exclude fluent-bit own logs
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /(yc-logging:|fluent bit.*version|inotify|storage.*version|cmetrics|ctraces|engine\]|registering|init|make TLS)/

# Exclude docker internal messages
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /(time=.*level=(warning|info).*msg=|forcibly turning on)/

# Exclude empty/whitespace-only logs
[FILTER]
    Name                grep
    Match               docker.*
    Exclude             log /^[ \t\n\r]*$/

[OUTPUT]
    Name  yc-logging
    Match docker.*
    resource_type generic_node
    group_id ${YC_LOG_GROUP_ID}
    message_key log
    default_level INFO
    authorization iam-token
    iam_token ${YC_TOKEN}
