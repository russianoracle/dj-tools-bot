name: Build Base Image

on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile.base'
      - 'requirements-prod-app.txt'
  workflow_dispatch:  # Manual trigger

env:
  REGISTRY: cr.yandex
  REGISTRY_ID: crp78hhr2t67jkeedad1
  PYTHON_VERSION: "3.12"
  SHARED_BUILDER: ci-shared-builder

jobs:
  build-base:
    name: Build and Push app-base
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Login to Yandex Container Registry
        run: |
          echo '${{ secrets.YC_SA_JSON_KEY }}' | docker login \
            ${{ env.REGISTRY }} \
            --username json_key \
            --password-stdin

      - name: Use shared builder
        run: |
          if ! docker buildx inspect ${{ env.SHARED_BUILDER }} >/dev/null 2>&1; then
            docker buildx create --name ${{ env.SHARED_BUILDER }} --driver docker-container --bootstrap
          fi
          docker buildx use ${{ env.SHARED_BUILDER }}

      - name: Pull existing image for cache
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/app-base:${{ env.PYTHON_VERSION }} 2>/dev/null || \
          echo "No previous image, building from scratch"

      - name: Build and push app-base image
        run: |
          echo "ðŸ”§ Building app-base:${{ env.PYTHON_VERSION }}"

          docker buildx build \
            --builder ${{ env.SHARED_BUILDER }} \
            -f Dockerfile.base \
            --build-arg PYTHON_VERSION=${{ env.PYTHON_VERSION }} \
            --cache-from type=registry,ref=${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/app-base:${{ env.PYTHON_VERSION }} \
            --cache-to type=inline \
            --pull=false \
            --push \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/app-base:${{ env.PYTHON_VERSION }} \
            .

          echo "âœ… app-base:${{ env.PYTHON_VERSION }} pushed to registry"

      - name: Verify image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/app-base:${{ env.PYTHON_VERSION }}
          docker run --rm ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/app-base:${{ env.PYTHON_VERSION }} \
            python -c "import librosa, aiogram, arq, psutil; print('âœ“ Dependencies verified')"

      - name: Logout from registry
        if: always()
        run: docker logout ${{ env.REGISTRY }} || true
